/*! @copyright Apollo GraphQL | @license MIT | @link apollographql.com | @version 2.2.13 *//* eslint-disable */import{__extends as t,__awaiter as r,__generator as e}from"./tslib.js";import{Observable as i,ApolloLink as n}from"./apollo-link.js";var o=function(){function t(t,i,n,o){var s=this;this.operation=t,this.nextLink=i,this.delayFor=n,this.retryIf=o,this.retryCount=0,this.values=[],this.complete=!1,this.canceled=!1,this.observers=[],this.currentSubscription=null,this.onNext=function(t){s.values.push(t);for(var r=0,e=s.observers;r<e.length;r++){var i=e[r];i&&i.next(t)}},this.onComplete=function(){s.complete=!0;for(var t=0,r=s.observers;t<r.length;t++){var e=r[t];e&&e.complete()}},this.onError=function(t){return r(s,void 0,void 0,function(){var r,i,n;return e(this,function(e){switch(e.label){case 0:return this.retryCount+=1,[4,this.retryIf(this.retryCount,this.operation,t)];case 1:if(e.sent())return this.scheduleRetry(this.delayFor(this.retryCount,this.operation,t)),[2];for(this.error=t,r=0,i=this.observers;r<i.length;r++)(n=i[r])&&n.error(t);return[2]}})})}}return t.prototype.subscribe=function(t){if(this.canceled)throw new Error("Subscribing to a retryable link that was canceled is not supported");this.observers.push(t);for(var r=0,e=this.values;r<e.length;r++){var i=e[r];t.next(i)}this.complete?t.complete():this.error&&t.error(this.error)},t.prototype.unsubscribe=function(t){var r=this.observers.indexOf(t);if(r<0)throw new Error("RetryLink BUG! Attempting to unsubscribe unknown observer!");this.observers[r]=null,this.observers.every(function(t){return null===t})&&this.cancel()},t.prototype.start=function(){this.currentSubscription||this.try()},t.prototype.cancel=function(){this.currentSubscription&&this.currentSubscription.unsubscribe(),clearTimeout(this.timerId),this.timerId=null,this.currentSubscription=null,this.canceled=!0},t.prototype.try=function(){this.currentSubscription=this.nextLink(this.operation).subscribe({next:this.onNext,error:this.onError,complete:this.onComplete})},t.prototype.scheduleRetry=function(t){var r=this;if(this.timerId)throw new Error("RetryLink BUG! Encountered overlapping retries");this.timerId=setTimeout(function(){r.timerId=null,r.try()},t)},t}(),s=function(r){function e(t){var e=r.call(this)||this,i=t||{},n=i.attempts,o=i.delay;return e.delayFor="function"==typeof o?o:function(t){var r=t||{},e=r.initial,i=void 0===e?300:e,n=r.jitter,o=void 0===n||n,s=r.max,u=void 0===s?1/0:s,c=o?i:i/2;return function(t){var r=Math.min(u,c*Math.pow(2,t));return o&&(r=Math.random()*r),r}}(o),e.retryIf="function"==typeof n?n:function(t){var r=t||{},e=r.retryIf,i=r.max,n=void 0===i?5:i;return function(t,r,i){return!(t>=n)&&(e?e(i,r):!!i)}}(n),e}return t(e,r),e.prototype.request=function(t,r){var e=new o(t,r,this.delayFor,this.retryIf);return e.start(),new i(function(t){return e.subscribe(t),function(){e.unsubscribe(t)}})},e}(n);export{s as RetryLink};