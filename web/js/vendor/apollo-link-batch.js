/*! @copyright Apollo GraphQL | @license MIT | @link apollographql.com | @version 1.1.12 *//* eslint-disable */import{__assign as e,__extends as t}from"./tslib.js";import{Observable as n,ApolloLink as r}from"./apollo-link.js";var u=function(){function t(e){var t=e.batchInterval,n=e.batchMax,r=e.batchHandler,u=e.batchKey;this.queuedRequests=new Map,this.batchInterval=t,this.batchMax=n||0,this.batchHandler=r,this.batchKey=u||function(){return""}}return t.prototype.enqueueRequest=function(t){var r=this,u=e({},t),o=!1,a=this.batchKey(t.operation);return u.observable||(u.observable=new n(function(e){r.queuedRequests.has(a)||r.queuedRequests.set(a,[]),o||(r.queuedRequests.get(a).push(u),o=!0),u.next=u.next||[],e.next&&u.next.push(e.next.bind(e)),u.error=u.error||[],e.error&&u.error.push(e.error.bind(e)),u.complete=u.complete||[],e.complete&&u.complete.push(e.complete.bind(e)),1===r.queuedRequests.get(a).length&&r.scheduleQueueConsumption(a),r.queuedRequests.get(a).length===r.batchMax&&r.consumeQueue(a)})),u.observable},t.prototype.consumeQueue=function(e){var t=e||"",r=this.queuedRequests.get(t);if(r){this.queuedRequests.delete(t);var u=r.map(function(e){return e.operation}),o=r.map(function(e){return e.forward}),a=[],c=[],s=[],h=[];r.forEach(function(e,t){a.push(e.observable),c.push(e.next),s.push(e.error),h.push(e.complete)});var i=this.batchHandler(u,o)||n.of(),l=function(e){s.forEach(function(t){t&&t.forEach(function(t){return t(e)})})};return i.subscribe({next:function(e){if(Array.isArray(e)||(e=[e]),c.length!==e.length){var t=new Error("server returned results with length "+e.length+", expected length of "+c.length);return t.result=e,l(t)}e.forEach(function(e,t){c[t]&&c[t].forEach(function(t){return t(e)})})},error:l,complete:function(){h.forEach(function(e){e&&e.forEach(function(e){return e()})})}}),a}},t.prototype.scheduleQueueConsumption=function(e){var t=this,n=e||"";setTimeout(function(){t.queuedRequests.get(n)&&t.queuedRequests.get(n).length&&t.consumeQueue(n)},this.batchInterval)},t}(),o=function(e){function n(t){var n=e.call(this)||this,r=t||{},o=r.batchInterval,a=void 0===o?10:o,c=r.batchMax,s=void 0===c?0:c,h=r.batchHandler,i=void 0===h?function(){return null}:h,l=r.batchKey,f=void 0===l?function(){return""}:l;return n.batcher=new u({batchInterval:a,batchMax:s,batchHandler:i,batchKey:f}),t.batchHandler.length<=1&&(n.request=function(e){return n.batcher.enqueueRequest({operation:e})}),n}return t(n,e),n.prototype.request=function(e,t){return this.batcher.enqueueRequest({operation:e,forward:t})},n}(r);export{o as BatchLink,u as OperationBatcher};